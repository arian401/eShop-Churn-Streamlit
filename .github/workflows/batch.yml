name: Weekly batch churn scoring

on:
  schedule:
    - cron: "0 3 * * *"      # every day at 03:00 UTC
  workflow_dispatch:

permissions:
  contents: write               # allow pushes with GITHUB_TOKEN

jobs:
  batch:
    runs-on: ubuntu-latest

    steps:
    # ── 1.  Check out repo ───────────────────────────────────────
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ── 2.  Set up Python & deps ─────────────────────────────────
    - uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: "pip"
    - run: pip install -r requirements.txt

    # ── 3.  Run predictor ────────────────────────────────────────
    - name: Run batch_predict.py
      run: python batch_predict.py

    # ── 4.  Capture the newest CSV path as an output ─────────────
    - id: latestcsv
      run: |
        latest=$(ls -1t reports/high_risk_customers_*.csv | head -1)
        echo "csv=$latest" >> "$GITHUB_OUTPUT"
        echo "Found latest CSV: $latest"

    # ── 5.  Commit & push CSV (force-add in case *.csv is ignored)
    - name: Commit report
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name  "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add -f ${{ steps.latestcsv.outputs.csv }} || true
        if ! git diff --cached --quiet; then
          git commit -m "Auto: churn report $(date -Iseconds)"
          git push origin HEAD:${{ github.event.repository.default_branch }}
        else
          echo "Nothing new to commit."
        fi

    # ── 6.  E-mail the CSV as an attachment ──────────────────────
    - name: Send report via e-mail
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "Churn report ${{ github.run_id }} ($(date -u +'%Y-%m-%d %H:%M UTC'))"
        to: am.s401@yahoo.com
        from: "Churn Bot <${{ secrets.SMTP_USERNAME }}>"
        html_body: |
          <p>Hello Amin,</p>
          <p>The latest high-risk customer report is attached.</p>
          <p>Run ID: <code>${{ github.run_id }}</code></p>
        attachments: ${{ steps.latestcsv.outputs.csv }}
